
# Фермерские продукты

Приложение для заказа свежих фермерских продуктов с доставкой в жилые комплексы.

## Особенности

- Каталог фермерских продуктов
- Корзина покупок и оформление заказа
- Выбор жилого комплекса для доставки
- Административная панель для управления
- Интеграция с Telegram ботом для уведомлений и CRM
- Управление транспортом для доставки

## Установка и запуск

### Веб-приложение

1. Клонируйте репозиторий:
```bash
git clone <URL_РЕПОЗИТОРИЯ>
cd <НАЗВАНИЕ_ДИРЕКТОРИИ>
```

2. Установите зависимости:
```bash
npm install
```

3. Запустите приложение в режиме разработки:
```bash
npm run dev
```

4. Откройте [http://localhost:5173](http://localhost:5173) в браузере.

## Запуск Telegram бота

Для работы уведомлений о заказах и напоминаний о доставке вам нужно запустить Telegram бот на сервере:

1. Создайте директорию для сервера бота:
```bash
mkdir telegram-bot-server
cd telegram-bot-server
```

2. Инициализируйте проект и установите зависимости:
```bash
npm init -y
npm install node-telegram-bot-api express body-parser dotenv fs path
```

3. Создайте файл `.env` с настройками бота:
```
TELEGRAM_BOT_TOKEN=7771643973:AAGwXlvLZ0LnY5cGYFB83qx7je69Bkh_78o
WEB_APP_URL=https://your-app-url.com
PORT=3000
```

4. Скопируйте файл `telegram-bot-server.js` из корня проекта в эту директорию.

5. Запустите бот:
```bash
node telegram-bot-server.js
```

6. Проверьте работу бота, отправив команду `/start` боту [@berry_farm_bot](https://t.me/berry_farm_bot) в Telegram.

## Проверка соединения с ботом

После запуска бота необходимо проверить соединение:

1. Откройте браузер и перейдите по URL `http://localhost:3000/health`
2. Вы должны увидеть JSON с информацией о статусе бота
3. Используйте `/test-connection/YOUR_TELEGRAM_ID` для проверки отправки тестового сообщения
4. Например: `http://localhost:3000/test-connection/123456789` (замените на ваш ID)

Если тестовое сообщение не приходит, проверьте логи сервера на наличие ошибок.

## Настройка уведомлений

1. Для работы уведомлений пользователю необходимо отправить команду `/start` боту
2. Бот автоматически сохранит Telegram ID, имя и username пользователя
3. При оформлении заказа система использует:
   - ID пользователя из Telegram WebApp (если заказ через Telegram)
   - Username Telegram, предоставленный при оформлении заказа
4. Все уведомления (создание заказа, изменение статуса, напоминания о доставке) отправляются автоматически

## CRM возможности

Система CRM включает в себя:

1. **Управление статусами заказов** 
   - Изменение статуса заказа с автоматическим уведомлением клиента
   - Отправка персонализированных сообщений при изменении статуса

2. **Управление доставкой**
   - Назначение транспортных средств для доставки
   - Групповое назначение автомобилей для нескольких заказов
   - Отправка уведомлений клиентам о назначенном транспорте

3. **Массовая обработка заказов**
   - Выделение нескольких заказов и групповое изменение их статуса
   - Массовая отправка уведомлений

### Коммуникация с клиентами

- Возможность отправки индивидуальных сообщений клиентам через Telegram
- Отслеживание доставки сообщений и уведомления об ошибках
- Поддержка HTML-форматирования в сообщениях

### Важные эндпоинты бота

- `/api/notify` - отправка уведомления пользователю
- `/api/user/:userId` - проверка существования пользователя по ID
- `/api/user-by-username/:username` - поиск пользователя по имени пользователя
- `/api/users` - получение списка всех пользователей
- `/health` - проверка работоспособности бота
- `/test-connection/:userId` - отправка тестового сообщения

## Решение проблем с уведомлениями

1. **Пользователь не получает уведомления:**
   - Убедитесь, что пользователь отправил команду `/start` боту
   - Проверьте, что правильно указан Telegram username (должен начинаться с @)
   - Проверьте, что сервер бота запущен и работает
   - Используйте эндпоинт `/test-connection/:userId` для проверки соединения

2. **Бот не запускается:**
   - Проверьте правильность токена бота
   - Убедитесь, что порт 3000 не занят другим приложением
   - Проверьте наличие всех необходимых зависимостей

3. **Ошибка при отправке уведомления:**
   - Проверьте, что в настройках админ-панели включены уведомления
   - Проверьте консоль сервера Telegram бота на наличие ошибок
   - Попробуйте перезапустить бот-сервер

## Режим обслуживания

Когда включен режим обслуживания:
- Обычные пользователи видят страницу с сообщением о техническом обслуживании
- Администраторы имеют полный доступ к сайту и могут продолжать работу
- Для отключения режима перейдите в Настройки в административной панели

## Технологии

- React
- TypeScript
- Tailwind CSS
- Supabase
- Node.js (для Telegram бота)
- Express (для Telegram бота)

## Обновление на GitHub

Чтобы обновить проект на GitHub, выполните следующие команды:

```bash
# Добавить все изменения
git add .

# Создать коммит
git commit -m "Добавлена интеграция с Telegram ботом и управление транспортом"

# Отправить изменения на GitHub
git push origin main
```

Для получения более подробной информации о работе с Telegram ботом, смотрите [telegram-bot-readme.md](telegram-bot-readme.md).
