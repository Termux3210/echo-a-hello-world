
# Telegram Bot Integration Guide

Этот документ объясняет, как настроить и запустить Telegram бота для сайта фермерских продуктов.

## Предварительные требования

- Node.js 14+ установлен
- npm или yarn менеджер пакетов
- Токен Telegram бота (уже настроен как: `7771643973:AAGwXlvLZ0LnY5cGYFB83qx7je69Bkh_78o`)

## Настройка и запуск сервера бота

1. Создайте новую директорию для сервера бота:

```bash
mkdir telegram-bot-server
cd telegram-bot-server
```

2. Инициализируйте новый Node.js проект:

```bash
npm init -y
```

3. Установите необходимые зависимости:

```bash
npm install node-telegram-bot-api express body-parser dotenv
```

4. Создайте файл `.env` с настройками:

```
TELEGRAM_BOT_TOKEN=7771643973:AAGwXlvLZ0LnY5cGYFB83qx7je69Bkh_78o
WEB_APP_URL=https://your-app-url.com
PORT=3000
```

5. Скопируйте файл `telegram-bot-server.js` из корня проекта в эту директорию.

6. **ОБЯЗАТЕЛЬНО**: Измените URL в файле `src/lib/telegramConfig.ts` на правильный URL вашего бота:

```typescript
// URL для webhook API бота (измените на ваш URL)
export const WEBHOOK_API_URL = "http://localhost:3000";
```

7. Запустите бота:

```bash
node telegram-bot-server.js
```

## ⚠️ ВАЖНО: Проверка соединения

После запуска бота, проверьте соединение, выполнив следующие шаги:

1. Откройте браузер и перейдите по URL `http://localhost:3000/health`
2. Вы должны увидеть JSON с информацией о статусе бота
3. Используйте конечную точку `/test-connection/YOUR_TELEGRAM_ID` для проверки отправки тестового сообщения
4. Пример: `http://localhost:3000/test-connection/123456789` (замените на ваш ID)

Если тестовое сообщение не приходит, проверьте логи сервера на наличие ошибок.

## Как бот запоминает пользователей

Бот автоматически сохраняет информацию о пользователях, которые взаимодействуют с ним:

1. Когда пользователь отправляет команду `/start`, бот сохраняет:
   - Telegram ID пользователя
   - Имя пользователя (username)
   - Имя и фамилию
   - Chat ID для отправки уведомлений

2. Данные сохраняются в файл `telegram_users.json` для постоянного хранения, поэтому бот помнит пользователей даже после перезапуска.

3. При оформлении заказа, система сохраняет Telegram ID пользователя в базе данных и связывает его с заказом.

## Как работают уведомления

Уведомления отправляются через бота в следующих случаях:

1. **При создании нового заказа** - пользователь получает подтверждение и детали заказа
2. **При изменении статуса заказа** - пользователь получает уведомление о новом статусе
3. **Ежедневные напоминания о доставке** - система автоматически отправляет напоминания о предстоящих доставках

### API для отправки уведомлений

Бот предоставляет API для отправки уведомлений:

```
POST /api/notify
{
  "userId": "123456789",  // Telegram user ID (числовой ID пользователя)
  "message": "Ваш заказ #123 подтвержден!",  // Текст сообщения
  "parseMode": "HTML"  // Optional: HTML или Markdown для форматирования
}
```

## Запуск бота за NAT/Firewall

Если ваш сервер находится за NAT или файрволлом, вам потребуется настроить проброс портов или использовать туннелирование:

### Использование ngrok для туннелирования (временное решение для тестирования):

1. Установите ngrok: https://ngrok.com/download
2. Запустите туннель:
```bash
ngrok http 3000
```
3. Обновите URL в файле `src/lib/telegramConfig.ts`:
```typescript
export const WEBHOOK_API_URL = "https://your-ngrok-url.ngrok.io";
```

### Настройка постоянного домена и SSL (для продакшн):

Для продакшн окружения рекомендуется настроить постоянный домен с SSL и правильно настроенные вебхуки.

## Возможные проблемы и решения

### Уведомления не приходят:

1. **Проверьте соединение с ботом**:
   - Отправьте команду `/start` боту
   - Убедитесь, что бот отвечает

2. **Проверьте логи сервера бота**:
   - Ищите ошибки в консоли
   - Обратите внимание на сообщения об ошибках при отправке уведомлений

3. **Проверьте наличие Telegram ID в заказе**:
   - Убедитесь, что при оформлении заказа сохраняется Telegram ID пользователя
   - Проверьте, что ID корректный

4. **Проверьте, что пользователь не заблокировал бота**:
   - Пользователь должен начать диалог с ботом с помощью команды `/start`
   - Если бот был заблокирован, пользователь должен разблокировать его

### Бот не запускается:

1. Проверьте правильность токена бота
2. Убедитесь, что порт 3000 не занят другим приложением
3. Проверьте наличие всех необходимых зависимостей

## Технические детали реализации

### Структура сообщений

Бот поддерживает HTML-форматирование в сообщениях. Пример:

```html
<b>Заказ #123 подтвержден!</b>
<i>Дата доставки:</i> 01.06.2023
<code>Специальный код: ABC123</code>
```

### Безопасность

- Токен бота должен храниться в безопасном месте (используйте файл `.env`)
- Веб-хуки защищены включением токена в URL
- API endpoints должны быть доступны только с вашего сервера

## FAQ

1. **Как узнать свой Telegram ID?**  
   Отправьте команду `/id` боту, и он вернет ваш ID.

2. **Должен ли пользователь подписываться на бота для получения уведомлений?**  
   Да, пользователь должен начать диалог с ботом (команда `/start`), иначе бот не сможет отправлять ему сообщения.

3. **Как проверить, что бот работает правильно?**  
   Отправьте команду `/start`, затем сделайте тестовый заказ. Вы должны получить уведомление о создании заказа.

4. **Как изменить язык уведомлений?**  
   Отредактируйте тексты сообщений в файлах `src/lib/telegramWebAppIntegration.ts` и `src/lib/deliveryReminders.ts`.
